name: docs

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Doxygen
      run: sudo apt-get update && sudo apt-get install -y doxygen

    - name: Generate Documentation
      run: doxygen

    - name: Publish to gh-pages branch
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      env:
        WORKTREE_DIR: ${{ runner.temp }}/gh-pages
      run: |
        set -euo pipefail
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global --add safe.directory "$(pwd)"

        docs_source="docs/html"
        worktree="${WORKTREE_DIR}"
        rm -rf "${worktree}"

        if git ls-remote --exit-code origin gh-pages >/dev/null 2>&1; then
          git fetch origin gh-pages
          git worktree add "${worktree}" gh-pages
        else
          git worktree add --orphan "${worktree}" gh-pages
        fi

        mkdir -p "${worktree}/docs"
        rsync -a --delete "${docs_source}/" "${worktree}/docs/"
        touch "${worktree}/.nojekyll"

        cd "${worktree}"
        git add --all
        if git rev-parse --verify HEAD >/dev/null 2>&1; then
          if git diff --cached --quiet; then
            echo "No documentation changes to publish."
            cd -
            git worktree remove "${worktree}"
            exit 0
          fi
        fi

        git commit -m "Update docs for ${GITHUB_SHA}"
        git push origin HEAD:gh-pages
        cd -
        git worktree remove "${worktree}"
